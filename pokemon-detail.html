<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Battle!</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Page-specific styles to emulate a Pokemon Go-like detail view */
    .detail-wrap { display: flex; flex-direction: column; height: 100%; background: #f5f5f7; }
    /* Make entire page (phone) the scroll container for this view */
    .phone.phone-column { overflow-y: auto; }

    /* Top card with portrait (no level arc) */
    .top-card {
      position: relative;
      background: linear-gradient(180deg, #89c4ff 0%, #ffffff 100%);
      padding: 24px 16px 64px;
      border-bottom: 1px solid #e5e5e5;
    }
    .cp-label { text-align: center; font-weight: 700; letter-spacing: 0.5px; color: #000; }
    .cp-value { text-align: center; font-size: 28px; font-weight: 800; margin-top: 6px; color: #000; }
    /* Put CP label and value on one line */
    .cp-row { display: flex; align-items: baseline; justify-content: center; gap: 6px; }
    .cp-row .cp-value { margin-top: 0; }
    /* Reserve vertical space for the portrait so name/meta don't crowd CP */
    .portrait-spacer { height: var(--portrait-spacer, 148px); }
    .portrait {
      position: absolute;
      left: 50%;
      /* top set dynamically to midpoint between CP and name */
      transform: translate(-50%, -50%);
      margin: 0;
      width: auto; height: auto;
      display: flex; align-items: center; justify-content: center;
      background: transparent; border: none; border-radius: 0; box-shadow: none;
      z-index: 1;
    }
    /* Sprite inside portrait */
    .portrait img { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: auto; transform: scale(2); transform-origin: center center; }
    .name-row { margin-top: 12px; text-align: center; font-size: 22px; font-weight: 800; color: #000; }
    .meta-row { margin-top: 6px; text-align: center; color: #1f2d3d; font-size: 13px; opacity: 0.85; }

    /* Type chips */
    .types { margin-top: 10px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .chip { padding: 4px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; color: #fff; }
    .t-normal{ background:#a8a77a; } .t-fire{ background:#ee8130; } .t-water{ background:#6390f0; }
    .t-electric{ background:#f7d02c; color:#212121; } .t-grass{ background:#7ac74c; }
    .t-ice{ background:#96d9d6; color:#212121; } .t-fighting{ background:#c22e28; }
    .t-poison{ background:#a33ea1; } .t-ground{ background:#e2bf65; color:#212121; }
    .t-flying{ background:#a98ff3; } .t-psychic{ background:#f95587; }
    .t-bug{ background:#a6b91a; } .t-rock{ background:#b6a136; }
    .t-ghost{ background:#735797; } .t-dragon{ background:#6f35fc; }
    .t-dark{ background:#705746; } .t-steel{ background:#b7b7ce; color:#212121; }
    .t-fairy{ background:#d685ad; }

    /* Content sections */
    /* Content now flows; parent handles scrolling */
    .content { flex: 1 1 auto; overflow: visible; padding: 12px; background:#f5f5f7; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius: 14px; padding: 12px; margin-bottom: 12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .label { color:#666; font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:0.4px; }
    .value { font-weight:800; color:#111; }

    /* HP bar */
    .hp-bar { height: 10px; background:#eee; border-radius: 999px; overflow: hidden; margin-top: 6px; }
    .hp-fill { height:100%; background:linear-gradient(90deg,#38d39f,#00b894); width: 50%; }

    /* IV-like stats */
    .iv { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top: 8px; }
    .iv .stat { text-align:center; }
    .iv .stat .bar { height: 8px; border-radius: 6px; background:#eee; overflow: hidden; }
    .iv .stat .fill { height: 100%; background:#007aff; width: 80%; }

    /* Moves list */
    .moves .move { display:flex; align-items:center; justify-content:space-between; padding: 10px 0; border-bottom:1px solid #f0f0f0; }
    .moves .move:last-child { border-bottom:none; }
    .moves .left { display:flex; align-items:center; gap:8px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#007aff; }
    .power { font-weight:800; }

    /* close button styles are shared in styles.css */
    /* Stats layout: four numbers in a single row with grey labels below */
    .stats-row { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; margin-top: 8px; }
    .stat-col .value { font-weight: 800; }
  </style>
  </head>
<body>
  <div class="phone phone-column">
    <div class="detail-wrap">
      <div class="top-card">
        <div class="cp-row">
          <div class="cp-label">CP</div>
          <div class="cp-value" id="cpValue">1234</div>
        </div>
        <div class="portrait-spacer" aria-hidden="true"></div>
        <div class="portrait" id="portrait" aria-label="Pokémon portrait"></div>
        <div class="name-row" id="nameRow">Pokemon</div>
        <div class="meta-row" id="metaRow">Lvl 20</div>
        <div class="types" id="typeChips"></div>
      </div>

      <div class="content" id="content">
        <div class="card">
          <div class="label">Stats</div>
          <div class="stats-row">
            <div class="stat-col">
              <div class="value" id="statHp">—</div>
              <div class="label">HP</div>
            </div>
            <div class="stat-col">
              <div class="value" id="statAtk">—</div>
              <div class="label">Attack</div>
            </div>
            <div class="stat-col">
              <div class="value" id="statDef">—</div>
              <div class="label">Defense</div>
            </div>
            <div class="stat-col">
              <div class="value" id="statSpd">—</div>
              <div class="label">Speed</div>
            </div>
          </div>
        </div>

        <div class="card moves">
          <div class="label" style="margin-bottom:6px;">Moves</div>
          <div class="move">
            <div class="left"><div class="dot"></div><div class="value" id="fastMove">Fast Move</div></div>
            <div class="power" id="fastPower">8</div>
          </div>
          <div class="move">
            <div class="left"><div class="dot"></div><div class="value" id="chargeMove1">Charge Move 1</div></div>
            <div class="power" id="chargePower1">70</div>
          </div>
          <div class="move">
            <div class="left"><div class="dot"></div><div class="value" id="chargeMove2">Charge Move 2</div></div>
            <div class="power" id="chargePower2">100</div>
          </div>
        </div>

        <div class="card">
          <button class="btn btn-primary" id="powerBtn" type="button" style="width:100%">Power Up</button>
        </div>
      </div>

      <div class="bottom-close">
        <button class="close-btn" id="closeBtn" type="button" aria-label="Close">&times;</button>
      </div>
    </div>
  </div>
  <script src="pokemon-types.js"></script>
  <script src="pokemon-moves-fast.js"></script>
  <script src="pokemon-moves-charged.js"></script>
  <script src="pokemon-species.js"></script>
  <script src="pokemon-stats.js"></script>
  <script src="pokemon-data.js"></script>
  <script src="shared.js"></script>
  <script>
    (function(){
      // Enable drag-to-scroll on the full page container
      const page = document.querySelector('.phone.phone-column');
      if (page && window.UI && typeof window.UI.attachDragScroll === 'function') {
        window.UI.attachDragScroll(page);
      }

      function readState() {
        try {
          const raw = localStorage.getItem('pogo-pvp-state');
          return raw ? JSON.parse(raw) : {};
        } catch (_) { return {}; }
      }
      const PD = window.PokemonData || {};
      const state = readState();
      const view = state.viewPokemon || {};
      const id = Number(view.id || 0) || (PD.all && PD.all[0] && PD.all[0].id) || 0;
      const mon = (PD.byId && PD.byId.get) ? PD.byId.get(id) : null;
      const name = (mon && mon.name) || (view.name || 'Pokemon');
      const level = 50; // placeholder level display
      const stats = (PD.getGoStatsById && id) ? PD.getGoStatsById(id, level) : { hp: 100, attack: 50, defense: 50, speed: 50 };
      const hpMax = Math.max(1, Number(stats.hp || 100));
      const atk = Number(stats.attack || 50);
      const def = Number(stats.defense || 50);
      const spd = Number(stats.speed || 50);
      const types = (mon && mon.types) || [];

      // Moves from PokemonData
      const fastId = mon && Array.isArray(mon.fastMoves) && mon.fastMoves[0];
      const fastDef = fastId && PD.FAST_MOVES_BY_ID ? PD.FAST_MOVES_BY_ID[fastId] : null;
      const chargedIds = (mon && Array.isArray(mon.chargedMoves)) ? mon.chargedMoves.slice(0, 2) : [];
      const ch1Def = chargedIds[0] && PD.CHARGED_MOVES_BY_ID ? PD.CHARGED_MOVES_BY_ID[chargedIds[0]] : null;
      const ch2Def = chargedIds[1] && PD.CHARGED_MOVES_BY_ID ? PD.CHARGED_MOVES_BY_ID[chargedIds[1]] : null;

      // Populate UI
      const $ = (id) => document.getElementById(id);
      // Simple CP derivation for display purposes
      const cp = PD.calcGoCp && stats ? PD.calcGoCp(stats) : 10;
      $('cpValue').textContent = cp;
      // Animated sprite portrait (use battle sprite URLs with PNG fallback)
      (function updatePortrait(){
        const host = $('portrait');
        if (!host) return;
        host.textContent = '';
        const img = document.createElement('img');
        img.alt = name;
        try {
          // TODO - shiny support
          const url = (PD.getBattleSpriteUrl ? PD.getBattleSpriteUrl(name, 'opponent', false) : null) || (PD.getForwardSpriteUrl ? PD.getForwardSpriteUrl(name) : '');
          img.src = url;
        } catch (_) {}
        // Fallback to static forward-facing PNG if GIF fails
        img.onerror = function(){
          if (PD.getForwardSpriteUrl) img.src = PD.getForwardSpriteUrl(name);
          img.onerror = null;
        };
        host.appendChild(img);

        // Position the portrait centered between CP text and name text
        function positionPortrait() {
          const topCard = document.querySelector('.top-card');
          const cpEl = document.querySelector('.cp-value');
          const nameEl = document.getElementById('nameRow');
          if (!topCard || !cpEl || !nameEl) return;
          const rTop = topCard.getBoundingClientRect();
          const rCp = cpEl.getBoundingClientRect();
          const rName = nameEl.getBoundingClientRect();
          const mid = ((rCp.bottom + rName.top) / 2) - rTop.top;
          host.style.top = `${mid}px`;
        }
        // Initial position after layout and on resize
        requestAnimationFrame(positionPortrait);
        window.addEventListener('resize', positionPortrait);
        // Reposition once sprite loads (in case fonts/layout shift)
        img.addEventListener('load', () => requestAnimationFrame(positionPortrait), { once: true });
      })();
      $('nameRow').textContent = name;
      $('metaRow').textContent = `Lvl ${level}`;
      // Fill numeric GO stats
      const setTxt = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
      setTxt('statHp', hpMax);
      setTxt('statAtk', atk);
      setTxt('statDef', def);
      setTxt('statSpd', spd);
      // Top-card background gradient based on first type
      (function updateTopGradient(){
        const COLORS = {
          normal:'#a8a77a', fire:'#ee8130', water:'#6390f0', electric:'#f7d02c', grass:'#7ac74c', ice:'#96d9d6',
          fighting:'#c22e28', poison:'#a33ea1', ground:'#e2bf65', flying:'#a98ff3', psychic:'#f95587', bug:'#a6b91a',
          rock:'#b6a136', ghost:'#735797', dragon:'#6f35fc', dark:'#705746', steel:'#b7b7ce', fairy:'#d685ad'
        };
        const topCard = document.querySelector('.top-card');
        const t = (types && types[0] || '').toLowerCase();
        const base = COLORS[t];
        if (topCard && base) {
          topCard.style.background = `linear-gradient(180deg, ${base} 0%, #ffffff 100%)`;
        }
      })();
      $('fastMove').textContent = (fastDef && fastDef.name) || 'Fast Move';
      $('chargeMove1').textContent = (ch1Def && ch1Def.name) || 'Charge Move 1';
      $('chargeMove2').textContent = (ch2Def && ch2Def.name) || 'Charge Move 2';
      $('fastPower').textContent = (fastDef && fastDef.power != null) ? fastDef.power : '';
      $('chargePower1').textContent = (ch1Def && ch1Def.power != null) ? ch1Def.power : '';
      $('chargePower2').textContent = (ch2Def && ch2Def.power != null) ? ch2Def.power : '';

      // Type chips
      const chipWrap = document.getElementById('typeChips');
      chipWrap.innerHTML = '';
      (types || []).forEach(t => {
        const chip = document.createElement('div');
        chip.className = `chip t-${t}`;
        chip.textContent = t.toUpperCase();
        chipWrap.appendChild(chip);
      });

      // Close (Back)
      const backBtn = document.getElementById('closeBtn');
      backBtn.addEventListener('click', () => {
        if (document.referrer) {
          history.back();
        } else {
          window.location.href = 'pokemon-list.html';
        }
      });

      // Power Up demo
      const powerBtn = document.getElementById('powerBtn');
      powerBtn.addEventListener('click', () => {
        // Simple demo: bump CP a bit
        const newCp = Math.round(Number(document.getElementById('cpValue').textContent) * 1.05);
        document.getElementById('cpValue').textContent = newCp;
      });
    })();
  </script>
</body>
</html>
