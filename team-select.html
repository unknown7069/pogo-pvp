<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Select</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root {
      --gap: 10px;
      --item-h: 92px; /* grid item height */
    }
    .phone {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      overflow: hidden;
      font-family: sans-serif;
      background: #fff;
    }
    .team-header {
      padding: 12px 16px;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }

    /* Top fixed selected slots */
    .top-select {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      background: #fff;
    }
    .slot {
      height: 72px;
      border: 2px dashed #cfcfcf;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-weight: 600;
      background: #fafafa;
    }
    .slot.filled {
      border-style: solid;
      border-color: #8a8a8a;
      color: #111;
      background: #fff;
    }

    /* Scrollable grid area (about 3.5 rows high) */
    .pokemon-grid {
      padding: 12px;
      background: #fafafa;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: var(--item-h);
      gap: var(--gap);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      height: calc(var(--item-h) * 3.5 + var(--gap) * 2.5 + 24px); /* approx 3.5 rows visible */
      cursor: grab; /* desktop hint */
    }
    .dragging {
      cursor: grabbing !important;
      user-select: none;
    }

    .pokemon-btn {
      width: 100%;
      height: 100%;
      border: 1px solid #d0d0d0;
      border-radius: 10px;
      background: #fff;
      color: #111;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, transform 0.05s;
    }
    .pokemon-btn:active { background: #f0f0f0; transform: scale(0.996); }
    .pokemon-btn.selected { outline: 3px solid #007aff; outline-offset: -3px; }

    /* Bottom fixed actions */
    .actions {
      padding: 10px 12px 14px;
      border-top: 1px solid #e5e5e5;
      background: #fff;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    .btn {
      padding: 14px 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      border: 1px solid transparent;
    }
    .btn-primary { background: #007aff; color: #fff; }
    .btn-secondary { background: #f2f2f7; color: #111; border-color: #d0d0d0; }
  </style>
</head>
<body>
  <div class="phone">
    <div class="team-header">team select</div>
    <div class="top-select">
      <div class="slot" data-slot="0">Empty</div>
      <div class="slot" data-slot="1">Empty</div>
      <div class="slot" data-slot="2">Empty</div>
    </div>
    <div class="pokemon-grid" id="pokemonGrid"></div>
    <div class="actions">
      <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button class="btn btn-primary" id="doneBtn">Done</button>
    </div>
  </div>
  <script src="shared.js"></script>
  <script>
    (function(){
      const grid = document.getElementById('pokemonGrid');
      const slots = Array.from(document.querySelectorAll('.slot'));
      const cancelBtn = document.getElementById('cancelBtn');
      const doneBtn = document.getElementById('doneBtn');

      // Build a sample list of Pokemon buttons
      const names = Array.from({length: 36}, (_, i) => `Pokemon ${i+1}`);

      function renderGrid() {
        grid.innerHTML = '';
        names.forEach((name, idx) => {
          const btn = document.createElement('button');
          btn.className = 'pokemon-btn';
          btn.type = 'button';
          btn.textContent = name;
          btn.dataset.name = name;
          btn.dataset.index = String(idx);
          grid.appendChild(btn);
        });
      }

      let workingTeam = [];

      function loadExisting() {
        const saved = window.AppState && window.AppState.get('selectedTeam', []);
        if (Array.isArray(saved)) workingTeam = saved.slice(0,3);
        updateSlots();
        updateGridSelection();
      }

      function updateSlots() {
        for (let i = 0; i < 3; i++) {
          const slot = slots[i];
          const name = workingTeam[i];
          if (name) {
            slot.textContent = name;
            slot.classList.add('filled');
          } else {
            slot.textContent = 'Empty';
            slot.classList.remove('filled');
          }
        }
      }

      function updateGridSelection() {
        const selectedSet = new Set(workingTeam);
        grid.querySelectorAll('.pokemon-btn').forEach(btn => {
          const selected = selectedSet.has(btn.dataset.name);
          btn.classList.toggle('selected', selected);
        });
      }

      // Clicking a pokemon adds/removes from working team (max 3)
      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.pokemon-btn');
        if (!btn) return;
        const name = btn.dataset.name;
        const i = workingTeam.indexOf(name);
        if (i !== -1) {
          workingTeam.splice(i,1);
        } else if (workingTeam.length < 3) {
          workingTeam.push(name);
        } else {
          // Replace the last one if already 3? Keep simple: ignore
          return;
        }
        updateSlots();
        updateGridSelection();
      });

      // Bottom actions
      cancelBtn.addEventListener('click', () => {
        // Do not persist working changes; just return
        window.location.href = 'battle.html';
      });
      doneBtn.addEventListener('click', () => {
        if (window.AppState && typeof window.AppState.set === 'function') {
          window.AppState.set('selectedTeam', workingTeam.slice(0,3));
        }
        window.location.href = 'battle.html';
      });

      // Enable click-and-drag scrolling similar to battle page
      let isDown = false;
      let startY = 0;
      let startScrollTop = 0;
      let didDrag = false;
      let suppressNextClick = false;

      const onPointerDown = (e) => {
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        isDown = true;
        grid.classList.add('dragging');
        startY = e.clientY;
        startScrollTop = grid.scrollTop;
        didDrag = false;
      };

      const onPointerMove = (e) => {
        if (!isDown) return;
        const dy = e.clientY - startY;
        if (Math.abs(dy) > 5) didDrag = true;
        grid.scrollTop = startScrollTop - dy;
      };

      const onPointerUp = () => {
        isDown = false;
        grid.classList.remove('dragging');
        if (didDrag) {
          suppressNextClick = true;
          setTimeout(() => { suppressNextClick = false; }, 0);
        }
      };

      const onClickCapture = (e) => {
        if (suppressNextClick) {
          e.preventDefault();
          e.stopPropagation();
        }
      };

      grid.addEventListener('pointerdown', onPointerDown);
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup', onPointerUp);
      window.addEventListener('pointercancel', onPointerUp);
      grid.addEventListener('click', onClickCapture, true);

      renderGrid();
      loadExisting();
    })();
  </script>
</body>
</html>
