<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Select</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Page-specific tweaks only; shared styles live in styles.css */
    .team-header {
      padding: 8px 12px;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }

    /* Top fixed selected slots */
    .top-select {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      background: #fff;
    }
    .slot {
      height: 72px;
      border: 2px dashed #cfcfcf;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-weight: 600;
      background: #fafafa;
    }
    .slot.filled {
      border-style: solid;
      border-color: #8a8a8a;
      color: #111;
      background: #fff;
    }

    .pokemon-grid { margin-top: var(--gap); }
    /* dragging state and button styles are shared */
  </style>
</head>
<body>
  <div class="phone phone-column">
    <div class="team-header">team select</div>
    <div class="top-select">
      <div class="slot" data-slot="0">Empty</div>
      <div class="slot" data-slot="1">Empty</div>
      <div class="slot" data-slot="2">Empty</div>
    </div>
    <div class="pokemon-grid" id="pokemonGrid"></div>
    <div class="actions action-bar two">
      <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button class="btn btn-primary" id="doneBtn">Done</button>
    </div>
  </div>
  <script src="shared.js"></script>
  <script>
    (function(){
      const grid = document.getElementById('pokemonGrid');
      const slots = Array.from(document.querySelectorAll('.slot'));
      const cancelBtn = document.getElementById('cancelBtn');
      const doneBtn = document.getElementById('doneBtn');
      const header = document.querySelector('.team-header');
      const topSelect = document.querySelector('.top-select');
      const actions = document.querySelector('.actions');

      // Build a sample list of Pokemon buttons
      const names = Array.from({length: 36}, (_, i) => `Pokemon ${i+1}`);

      function renderGrid() {
        grid.innerHTML = '';
        names.forEach((name, idx) => {
          const btn = document.createElement('button');
          btn.className = 'pokemon-btn';
          btn.type = 'button';
          btn.textContent = name;
          btn.dataset.name = name;
          btn.dataset.index = String(idx);
          grid.appendChild(btn);
        });
      }

      let workingTeam = [];
      let selecting = true;

      function loadExisting() {
        const saved = window.AppState && window.AppState.get('selectedTeam', []);
        if (Array.isArray(saved)) workingTeam = saved.slice(0,3);
        updateSlots();
        updateGridSelection();
      }

      function updateSlots() {
        for (let i = 0; i < 3; i++) {
          const slot = slots[i];
          const name = workingTeam[i];
          if (name) {
            slot.textContent = name;
            slot.classList.add('filled');
          } else {
            slot.textContent = 'Empty';
            slot.classList.remove('filled');
          }
        }
      }

      function updateGridSelection() {
        const selectedSet = new Set(workingTeam);
        grid.querySelectorAll('.pokemon-btn').forEach(btn => {
          const selected = selectedSet.has(btn.dataset.name);
          btn.classList.toggle('selected', selected);
        });
      }

      // Clicking a pokemon adds/removes from working team (max 3)
      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.pokemon-btn');
        if (!btn) return;
        if (!selecting) return; // view mode: ignore selection changes
        const name = btn.dataset.name;
        const i = workingTeam.indexOf(name);
        if (i !== -1) {
          workingTeam.splice(i,1);
        } else if (workingTeam.length < 3) {
          workingTeam.push(name);
        } else {
          // Replace the last one if already 3? Keep simple: ignore
          return;
        }
        updateSlots();
        updateGridSelection();
      });

      // Bottom actions
      cancelBtn.addEventListener('click', () => {
        // Do not persist working changes; just return
        window.location.href = 'rocket-select.html';
      });
      doneBtn.addEventListener('click', () => {
        if (window.AppState && typeof window.AppState.set === 'function') {
          window.AppState.set('selectedTeam', workingTeam.slice(0,3));
        }
        // Proceed to the new battle page after selection
        window.location.href = 'battle.html';
      });

      // Enable click-and-drag scrolling using shared helper
      if (window.UI && typeof window.UI.attachDragScroll === 'function') {
        window.UI.attachDragScroll(grid);
      }

      function updateModeUI() {
        if (topSelect) topSelect.style.display = selecting ? '' : 'none';
        if (actions) actions.style.display = selecting ? '' : 'none';
        if (header) {
          if (selecting) {
            header.style.display = '';
            header.textContent = 'team select';
          } else {
            header.style.display = 'none';
          }
        }
      }

      // This page is dedicated to selecting a team
      selecting = true;

      renderGrid();
      loadExisting();
      updateModeUI();
    })();
  </script>
</body>
</html>
