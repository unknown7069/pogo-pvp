<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Select</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="phone phone-column team-select-page">
    <div class="team-header">team select</div>
    <div class="top-select">
      <div class="slot" data-slot="0">Empty</div>
      <div class="slot" data-slot="1">Empty</div>
      <div class="slot" data-slot="2">Empty</div>
    </div>
    <div class="pokemon-grid" id="pokemonGrid"></div>
    <div class="actions action-bar two">
      <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button class="btn btn-primary" id="doneBtn">Done</button>
    </div>
  </div>
  <script src="shared.js"></script>
  <script>
    (function(){
      const MAX_TEAM = 3;

      const grid = document.getElementById('pokemonGrid');
      const slots = Array.from(document.querySelectorAll('.slot'));
      const cancelBtn = document.getElementById('cancelBtn');
      const doneBtn = document.getElementById('doneBtn');

      // Build a sample list of Pokemon buttons
      const names = Array.from({length: 36}, (_, i) => `Pokemon ${i+1}`);

      // Map for fast button lookups by name
      const buttonsByName = new Map();
      // Track previous selected set to diff UI updates
      let prevSelected = new Set();

      function renderGrid() {
        // Clear and batch-insert for minimal reflow
        grid.textContent = '';
        const frag = document.createDocumentFragment();
        names.forEach((name, idx) => {
          const btn = document.createElement('button');
          btn.className = 'pokemon-btn';
          btn.type = 'button';
          btn.textContent = name;
          btn.dataset.name = name;
          btn.dataset.index = String(idx);
          btn.setAttribute('aria-pressed', 'false');
          buttonsByName.set(name, btn);
          frag.appendChild(btn);
        });
        grid.appendChild(frag);
      }

      let workingTeam = [];

      function readState() {
        try {
          const raw = localStorage.getItem('pogo-pvp-state');
          return raw ? JSON.parse(raw) : {};
        } catch (_) { return {}; }
      }

      function writeState(patch) {
        try {
          const state = readState();
          const next = Object.assign({}, state, patch);
          localStorage.setItem('pogo-pvp-state', JSON.stringify(next));
        } catch (_) { /* ignore */ }
      }

      function loadExisting() {
        const state = readState();
        const saved = Array.isArray(state.selectedTeam) ? state.selectedTeam : [];
        workingTeam = saved.slice(0, MAX_TEAM);
        updateSlots();
        updateGridSelection();
      }

      function updateSlots() {
        for (let i = 0; i < MAX_TEAM; i++) {
          const slot = slots[i];
          const name = workingTeam[i];
          if (name) {
            slot.textContent = name;
            slot.classList.add('filled');
          } else {
            slot.textContent = 'Empty';
            slot.classList.remove('filled');
          }
        }
      }

      function updateGridSelection() {
        const selected = new Set(workingTeam);
        // Remove selection for items no longer selected
        prevSelected.forEach((name) => {
          if (!selected.has(name)) {
            const btn = buttonsByName.get(name);
            if (btn) {
              btn.classList.remove('selected');
              btn.setAttribute('aria-pressed', 'false');
            }
          }
        });
        // Add selection for new items
        selected.forEach((name) => {
          if (!prevSelected.has(name)) {
            const btn = buttonsByName.get(name);
            if (btn) {
              btn.classList.add('selected');
              btn.setAttribute('aria-pressed', 'true');
            }
          }
        });
        prevSelected = selected;
      }

      // Clicking a pokemon adds/removes from working team (max MAX_TEAM)
      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.pokemon-btn');
        if (!btn) return;
        const name = btn.dataset.name;
        const i = workingTeam.indexOf(name);
        if (i !== -1) {
          workingTeam.splice(i, 1);
        } else if (workingTeam.length < MAX_TEAM) {
          workingTeam.push(name);
        } else {
          // Team is full; ignore extra selections
          return;
        }
        updateSlots();
        updateGridSelection();
      });

      // Bottom actions
      cancelBtn.addEventListener('click', () => {
        // Do not persist working changes; just return
        window.location.href = 'rocket-select.html';
      });
      doneBtn.addEventListener('click', () => {
        const finalTeam = workingTeam.slice(0, MAX_TEAM);
        writeState({ selectedTeam: finalTeam });
        // Navigate directly; team is in localStorage now
        window.location.href = 'battle.html';
      });

      // Enable click-and-drag scrolling using shared helper
      if (window.UI && typeof window.UI.attachDragScroll === 'function') {
        window.UI.attachDragScroll(grid);
      }

      // Initial render + hydrate from saved state
      renderGrid();
      loadExisting();
    })();
  </script>
</body>
</html>
