<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Battle</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Battle page styles (scoped) */
    .battle-screen { display: grid; grid-template-rows: auto auto 1fr auto; height: 100%; }
    .battle-screen *, .battle-screen *::before, .battle-screen *::after { box-sizing: border-box; }

    /* Page background image (covers entire phone page) */
    .phone.phone-column {
      background: #000 url('img/battle_background.png') center / cover no-repeat;
    }

    /* Stage area sits on top; let page background show through */
    .battle-stage {
      position: relative;
      background: transparent;
      overflow: hidden;
    }

    /* Top status bar: opponent (left) and player (right) */
    .battle-forfeit { display:flex; align-items:center; padding: 6px 8px; background: transparent; border-bottom:none; }
    .forfeit-btn { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.6); background: rgba(255,255,255,0.22); color:#fff; font-weight:700; cursor:pointer; }
    .forfeit-btn:active { transform: translateY(1px); }
    .battle-topbar { display: flex; justify-content: space-between; padding: 10px 12px; gap: 10px; background: transparent; border-bottom:none; flex-wrap: nowrap; align-items: center; }
    .trainer-side { display: flex; align-items: center; gap: 8px; min-width: 0; flex: 1 1 0; }
    .trainer-side.player { order: 1; justify-content: flex-start; }
    .trainer-side.opponent { order: 2; justify-content: flex-end; }

    .hp-card { background: rgba(0,0,0,0.6); border: none; border-radius: 8px; padding: 8px 10px; width: 100%; max-width: 260px; min-width: 0; box-shadow: none; }
    .hp-name-row { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px; font-weight:700; color:#fff; }
    .hp-name-row .left { display:flex; align-items:center; gap:8px; min-width:0; }
    .hp-name-row .name { font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:12px; }
    .hp-name-row .cp { font-weight:800; color:#fff; font-size:12px; }
    .type-icons { display:flex; gap:4px; align-items:center; flex-wrap:wrap; }
    .type-dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,0.9); }
    /* Type colors */
    .t-normal{ background:#a8a77a; } .t-fire{ background:#ee8130; } .t-water{ background:#6390f0; }
    .t-electric{ background:#f7d02c; } .t-grass{ background:#7ac74c; }
    .t-ice{ background:#96d9d6; } .t-fighting{ background:#c22e28; }
    .t-poison{ background:#a33ea1; } .t-ground{ background:#e2bf65; }
    .t-flying{ background:#a98ff3; } .t-psychic{ background:#f95587; }
    .t-bug{ background:#a6b91a; } .t-rock{ background:#b6a136; }
    .t-ghost{ background:#735797; } .t-dragon{ background:#6f35fc; }
    .t-dark{ background:#705746; } .t-steel{ background:#b7b7ce; }
    .t-fairy{ background:#d685ad; }
    .hp-bar-wrap { position:relative; height:10px; background:rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.6); border-radius:6px; overflow:hidden; }
    /* White overlay to show most recent damage (previous HP) */
    .hp-recent { position:absolute; inset:0 auto 0 0; width:var(--hp-recent, 0%); background: rgba(255,255,255,0.9); transition: width 600ms ease; }
    .hp-bar { position:absolute; inset:0 auto 0 0; width:var(--hp,100%); background:linear-gradient(90deg,#2ecc71,#27ae60); transition: width 200ms ease, background 150ms; }
    /* Slot to anchor hit text near HP bar */
    .effect-slot { position: relative; height: 0; }
    /* Energy bar below HP */
    .energy-bar-wrap { position:relative; height:6px; background:rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.6); border-radius:6px; overflow:hidden; margin-top:4px; }
    .energy-bar { position:absolute; inset:0 auto 0 0; width:var(--en,0%); background:linear-gradient(90deg,#00b4ff,#007aff); transition: width 200ms ease; }
    .hp-count { font-size:12px; opacity:0.8; margin-top:4px; display:flex; justify-content:space-between; align-items:center; }
    .status-buff { font-size: 8px; font-weight: 1000; padding: 2px 4px; border-radius: 4px; background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.6); margin-right: 6px; }
    .pokemon-orbs { display:flex; gap:4px; margin-left:6px; }
    .pokemon-orbs .orb { width:10px; height:10px; border-radius:50%; background:#ddd; border:1px solid #333; }
    .pokemon-orbs .orb.active { background:#4caf50; }

    /* Sprites in the middle stage */
    .sprite { position:absolute; width:min(42%, 240px); height:min(42%, 240px); display:flex; align-items:flex-end; justify-content:center; border-radius:50%; background: transparent; border: none; box-shadow: none; z-index: 1; overflow: visible; }
    /* Anchor sprites by their bottoms so differing image sizes align consistently */
    .sprite.opponent { right: -2%; bottom: 62%; top: auto; transform: scaleX(-1); }
    .sprite.player { left: 14%; bottom: 27%; }

    /* Floating hit text (e.g., Super Effective!) */
    .effect-text { position:absolute; top:0; left:50%; transform: translateX(-50%) translateY(0); background: transparent; color:#fff; font-weight:800; font-size:12px; padding: 2px 6px; border-radius: 6px; opacity: 1; pointer-events:none; transition: opacity 600ms ease, transform 600ms ease; will-change: opacity, transform; white-space: nowrap; z-index: 2; min-width: 180px; text-align: center; }
    .effect-text.fade { opacity: 0.4; transform: translateX(-50%) translateY(-2px); }
    /* Keep opponent text upright despite parent mirror */
    .sprite.opponent .effect-text { transform: translateX(-50%) translateY(0) scaleX(-1); }
    .sprite.opponent .effect-text.fade { transform: translateX(-50%) translateY(-2px) scaleX(-1); }

    /* Sprite <img> sizing */
    .sprite img { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: auto; pointer-events: none; transform: scale(2); transform-origin: bottom center; }
    /* Depth cues: slightly smaller opponent, slightly larger player */
    .sprite.player img { transform: scale(2.5); }
    /* Counteract container flip for opponent so front sprite isn't mirrored, include scale */
    .sprite.opponent img { transform: scaleX(-1) scale(1.5); }

    /* Fast-attack lunge animations (duration scales with attackRate) */
    .sprite img.lunge-player { animation: player-lunge var(--lunge-duration, 180ms) ease-out; }
    .sprite img.lunge-opponent { animation: opponent-lunge var(--lunge-duration, 180ms) ease-out; }
    @keyframes player-lunge {
      0% { transform: scale(2.5) translateX(0); }
      50% { transform: scale(2.5) translateX(18%); }
      100% { transform: scale(2.5) translateX(0); }
    }
    /* Include scaleX(-1) to preserve opponent facing during animation */
    @keyframes opponent-lunge {
      0% { transform: scaleX(-1) scale(1.5) translateX(0); }
      50% { transform: scaleX(-1) scale(1.5) translateX(-18%); }
      100% { transform: scaleX(-1) scale(1.5) translateX(0); }
    }

    /* Bottom action area with three circular moves */
    .battle-actions { background: transparent; border-top:none; padding:12px 16px 16px; display:grid; grid-template-columns:repeat(3, 1fr); gap:14px; align-items: start; }
    .move { display:flex; flex-direction:column-reverse; align-items:center; justify-content:flex-start; gap:6px; min-width:0; }
    .move-btn { width: clamp(56px, 10vw + 28px, 84px); height: clamp(56px, 10vw + 28px, 84px); border-radius: 999px; background: rgba(255,255,255,0.22); border:2px solid rgba(255,255,255,0.7); cursor:pointer; user-select:none; transition: transform 80ms ease, background 120ms ease; display:block; }
    .move-btn:hover { background: rgba(255,255,255,0.3); }
    .move-btn:active { transform: translateY(1px); }
    .move-label { font-size: 12px; font-weight: 700; text-align: center; color: #fff; max-width: 100%; }

    @media (max-width: 720px) {
      .sprite { width:min(50%, 220px); height:min(50%, 220px); }
    }

    @media (max-width: 380px) {
      .battle-topbar { padding: 8px; gap: 8px; }
      .hp-count { font-size: 11px; }
    }

    /* Overlay confirm dialog */
    .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 10; padding: 20px; }
    .confirm-overlay.show { display: flex; }
    .confirm-card { width: 100%; max-width: 360px; background: #fff; border-radius: 12px; border: 1px solid #d0d0d0; box-shadow: 0 10px 24px rgba(0,0,0,0.15); overflow: hidden; }
    .confirm-body { padding: 16px; font-weight: 700; text-align: center; }
    .confirm-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; border-top: 1px solid #eee; background: #fafafa; }
    .btn-danger { background: #ff3b30; color: #fff; border: 1px solid transparent; }

    /* Countdown overlay (blocks interaction for 3s) */
    .countdown-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 20; }
    .countdown-overlay.show { display: flex; }
    .countdown-number { color: #fff; font-weight: 900; font-size: clamp(48px, 12vw, 96px); text-shadow: 0 6px 18px rgba(0,0,0,0.5); }
    .countdown-number.pop { animation: cd-pop 400ms ease both; }
    @keyframes cd-pop { from { transform: scale(0.6); opacity: 0.4; } to { transform: scale(1); opacity: 1; } }

    /* Disabled state visuals */
    .move-btn:disabled, .forfeit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  
    .hp-hidden { display:none; }

    /* Switch overlay (choose next Pokémon) */
    .switch-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 25; padding: 20px; }
    .switch-overlay.show { display: flex; }
    .switch-card { width: 100%; max-width: 420px; background: #fff; border-radius: 12px; border: 1px solid #d0d0d0; box-shadow: 0 10px 24px rgba(0,0,0,0.18); overflow: hidden; display:flex; flex-direction:column; }
    .switch-header { padding: 14px 16px; font-weight: 800; text-align: center; border-bottom: 1px solid #eee; }
    .switch-countdown { font-weight: 800; color: #ff3b30; }
    .switch-options { padding: 12px; display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .switch-btn { padding: 14px; border-radius: 10px; border: 1px solid #d0d0d0; background: #fafafa; font-weight: 700; cursor: pointer; }
    .switch-btn:active { transform: translateY(1px); }

    /* Fade to black overlay at battle end */
    .fade-overlay { position: fixed; inset: 0; background: #000; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 400ms ease; }
    .fade-overlay.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="phone phone-column">
    <main class="battle-screen" role="main">
      <!-- Top bars -->
      <section class="battle-forfeit">
        <button class="forfeit-btn" id="forfeitBtn" type="button">Forfeit</button>
      </section>

      <section class="battle-topbar">
        <div class="trainer-side opponent">
          <div class="hp-card">
            <div class="hp-name-row">
              <div class="left">
                <span class="name" id="opponent-name">Opponent</span>
                <span class="type-icons" id="opponent-types"></span>
              </div>
              <div class="cp" id="opponent-cp">CP 1000</div>
            </div>
              <div class="hp-bar-wrap" aria-label="Opponent HP">
              <div class="hp-recent" id="opponent-hp-recent" style="--hp-recent: 80%"></div>
              <div class="hp-bar" id="opponent-hp" style="--hp: 80%"></div>
            </div>
            <div class="effect-slot" id="opponent-effect-slot"></div>
            <div class="energy-bar-wrap" aria-label="Opponent Energy">
              <div class="energy-bar" id="opponent-energy" style="--en: 0%"></div>
            </div>
            <div class="hp-count">
              <span><span id="opponent-hp-text" class="hp-hidden"></span></span>
              <span class="pokemon-orbs" aria-label="Opponent remaining Pokemon">
                <span class="status-buff" id="opponent-attack-buff"></span>
                <span class="status-buff" id="opponent-defence-buff"></span>
                <span class="status-buff" id="opponent-speed-buff"></span>
                <span class="orb active"></span>
                <span class="orb active"></span>
                <span class="orb active"></span>
              </span>
            </div>
          </div>
        </div>

        <div class="trainer-side player">
          <div class="hp-card">
            <div class="hp-name-row">
              <div class="left">
                <span class="name" id="player-name">You</span>
                <span class="type-icons" id="player-types"></span>
              </div>
              <div class="cp" id="player-cp">CP 1000</div>
            </div>
              <div class="hp-bar-wrap" aria-label="Player HP">
              <div class="hp-recent" id="player-hp-recent" style="--hp-recent: 100%"></div>
              <div class="hp-bar" id="player-hp" style="--hp: 100%"></div>
            </div>
            <div class="effect-slot" id="player-effect-slot"></div>
            <div class="energy-bar-wrap" aria-label="Player Energy">
              <div class="energy-bar" id="player-energy" style="--en: 0%"></div>
            </div>
            <div class="hp-count">
              <span><span id="player-hp-text" class="hp-hidden"></span></span>
              <span class="pokemon-orbs" aria-label="Your remaining Pokemon">
                <span class="status-buff" id="player-attack-buff">x</span>
                <span class="status-buff" id="player-defence-buff"></span>
                <span class="status-buff" id="player-speed-buff"></span>
                <span class="orb active"></span>
                <span class="orb active"></span>
                <span class="orb active"></span>
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- Stage area -->
      <section class="battle-stage" role="img" aria-label="Battle stage">
        <div class="sprite opponent" aria-label="Opponent Pokemon">
          <img id="opponent-sprite-img" alt="Opponent Pokémon" />
        </div>
        <div class="sprite player" aria-label="Your Pokemon">
          <img id="player-sprite-img" alt="Your Pokémon" />
        </div>
      </section>

      <!-- Actions -->
      <section class="battle-actions" aria-label="Battle actions">
        <div class="move">
          <button class="move-btn" data-move="move1" aria-label="Move 1"></button>
          <div class="move-label">Move 1</div>
        </div>
        <div class="move">
          <button class="move-btn" data-move="move2" aria-label="Move 2"></button>
          <div class="move-label">Move 2</div>
        </div>
        <div class="move">
          <button class="move-btn" data-move="move3" aria-label="Move 3"></button>
          <div class="move-label">Move 3</div>
        </div>
      </section>

      <!-- Overlay confirmation dialog for forfeiting -->
      <div class="confirm-overlay" id="forfeitOverlay" role="dialog" aria-modal="true" aria-labelledby="forfeitTitle">
        <div class="confirm-card">
          <div class="confirm-body" id="forfeitTitle">Are you sure you want to forfeit?</div>
          <div class="confirm-actions">
            <button class="btn btn-secondary" id="cancelForfeit" type="button">Cancel</button>
            <button class="btn btn-danger" id="confirmForfeit" type="button">Forfeit</button>
          </div>
        </div>
      </div>

      <!-- 3-second countdown overlay -->
      <div class="countdown-overlay" id="countdownOverlay" aria-hidden="true">
        <div class="countdown-number" id="countdownText">3</div>
      </div>

      <!-- Switch overlay for selecting next Pokémon -->
      <div class="switch-overlay" id="switchOverlay" role="dialog" aria-modal="true" aria-labelledby="switchTitle">
        <div class="switch-card">
          <div class="switch-header" id="switchTitle">
            Choose next Pokémon · <span class="switch-countdown" id="switchCountdown">5</span>s
          </div>
          <div class="switch-options" id="switchOptions"></div>
        </div>
      </div>

      <!-- No team selected error overlay -->
      <div class="confirm-overlay" id="noTeamOverlay" role="alertdialog" aria-modal="true" aria-labelledby="noTeamTitle">
        <div class="confirm-card">
          <div class="confirm-body" id="noTeamTitle">No team selected. Please choose your team first.</div>
          <div class="confirm-actions">
            <button class="btn btn-primary" id="noTeamBackBtn" type="button">Return to Rocket Select</button>
          </div>
        </div>
      </div>

      <!-- Fade overlay used at battle end -->
      <div class="fade-overlay" id="fadeOverlay" aria-hidden="true"></div>
    </main>
  </div>

  <script src="pokemon-types.js"></script>
  <script src="pokemon-moves-fast.js"></script>
  <script src="pokemon-moves-charged.js"></script>
  <script src="pokemon-species.js"></script>
  <script src="pokemon-stats.js"></script>
  <script src="pokemon-data.js"></script>
  <script src="shared.js"></script>
  <script src="saving.js"></script>
  <script src="battle.js"></script>
</body>
</html>
